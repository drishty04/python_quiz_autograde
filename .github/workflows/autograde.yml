name: Autograde Jupyter Notebook Quiz

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  grade:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install nbconvert jupyter nbformat

      - name: Find submission
        id: find
        run: |
          NOTEBOOK=$(find submissions -name "*.ipynb" | head -n 1)
          echo "notebook=$NOTEBOOK" >> $GITHUB_OUTPUT
          echo "Found $NOTEBOOK"

      - name: Execute notebook
        run: |
          jupyter nbconvert --to notebook --execute "${{ steps.find.outputs.notebook }}"             --output executed_notebook.ipynb --ExecutePreprocessor.timeout=60

      - name: Grade notebook
        run: |
          python3 - <<'PYCODE'
import nbformat, runpy, json
from nbconvert import PythonExporter
from pathlib import Path

exporter = PythonExporter()
code, _ = exporter.from_file("executed_notebook.ipynb")
namespace = {}
exec(code, namespace)

from answer_key_quiz1 import grade
result = grade(namespace)

json.dump(result, open("grading_result.json", "w"), indent=2)
PYCODE

      - name: Comment result
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const r = JSON.parse(fs.readFileSync('grading_result.json', 'utf8'));
            let msg = `**Auto-graded Result**\n\n` +
                      `Score: **${r.score}/${r.total} (${r.percent.toFixed(1)}%)**\n\n`;
            for (const [k,v] of Object.entries(r.feedback)) msg += `- ${k}: ${v}\n`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: msg
            });
